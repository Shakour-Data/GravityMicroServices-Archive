# API Gateway - Independent Infrastructure
# This docker-compose file provides completely independent infrastructure
# Backend service URLs should be configured via .env file

version: '3.8'

services:
  # Redis for Rate Limiting & Caching - Dedicated for API Gateway
  api-gateway-redis:
    image: redis:7-alpine
    container_name: api-gateway-redis
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - api_gateway_redis_data:/data
    networks:
      - api-gateway-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 3

  # API Gateway Application
  api-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: api-gateway-app
    ports:
      - "8000:8000" # API Gateway port
      - "9090:9090" # Prometheus metrics
    environment:
      # Application
      APP_NAME: api-gateway
      APP_ENV: ${APP_ENV:-development}
      DEBUG: ${DEBUG:-true}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      API_VERSION: 1.0.0

      # Server
      HOST: 0.0.0.0
      PORT: 8000
      WORKERS: 4

      # Redis (internal)
      REDIS_URL: redis://api-gateway-redis:6379/1
      REDIS_MAX_CONNECTIONS: 50

      # JWT Configuration
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-super-secret-jwt-key-change-this}
      JWT_ALGORITHM: HS256

      # CORS
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:8080}
      CORS_CREDENTIALS: "true"

      # Rate Limiting
      RATE_LIMIT_ENABLED: "true"
      RATE_LIMIT_REQUESTS_PER_MINUTE: 100
      RATE_LIMIT_REQUESTS_PER_HOUR: 5000

      # Circuit Breaker
      CIRCUIT_BREAKER_ENABLED: "true"
      CIRCUIT_BREAKER_FAILURE_THRESHOLD: 5
      CIRCUIT_BREAKER_RECOVERY_TIMEOUT: 60
      CIRCUIT_BREAKER_HALF_OPEN_MAX_CALLS: 3

      # Backend Service URLs (from .env file - NO DEPENDENCIES)
      # These should point to external services when deployed
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL:-http://localhost:8001}
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://localhost:8002}
      NOTIFICATION_SERVICE_URL: ${NOTIFICATION_SERVICE_URL:-http://localhost:8003}
      FILE_SERVICE_URL: ${FILE_SERVICE_URL:-http://localhost:8004}
      PAYMENT_SERVICE_URL: ${PAYMENT_SERVICE_URL:-http://localhost:8005}

      # Timeouts
      REQUEST_TIMEOUT: 30
      CONNECT_TIMEOUT: 5

      # Monitoring
      PROMETHEUS_ENABLED: "true"
    depends_on:
      api-gateway-redis:
        condition: service_healthy
    networks:
      - api-gateway-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - ./app:/app/app:ro # Read-only for production
    # For development, uncomment:
    # volumes:
    #   - ./app:/app/app
    #   - ./tests:/app/tests

    # Volumes for data persistence
volumes:
  api_gateway_redis_data:
    driver: local
    name: api_gateway_redis_data

# Isolated network for API Gateway
networks:
  api-gateway-network:
    driver: bridge
    name: api_gateway_network
