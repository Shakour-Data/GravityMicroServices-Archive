# ================================================================================
# FILE IDENTITY (Ø´Ù†Ø§Ø³Ù†Ø§Ù…Ù‡ ÙØ§ÛŒÙ„)
# ================================================================================
# Project      : Gravity MicroServices Platform
# File         : .github/workflows/pull-request-checks.yml
# Description  : Comprehensive PR validation including code quality, tests,
#                security scans, and automated reviews
# Language     : YAML / GitHub Actions
#
# ================================================================================
# AUTHORSHIP & CONTRIBUTION (Ù…Ø´Ø§Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù†)
# ================================================================================
# Primary Author    : Lars BjÃ¶rkman (DevOps & Infrastructure Lead)
# Contributors      : JoÃ£o Silva (QA Lead), Michael Rodriguez (Security)
# Team Standard     : Elite Engineers (IQ 180+, 15+ years experience)
#
# ================================================================================
# TIMELINE & EFFORT (Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ ØªÙ„Ø§Ø´)
# ================================================================================
# Created Date      : 2025-11-07 14:00 UTC
# Total Time        : 2 hours 0 minutes
# Total Cost        : $300.00 USD
#
# ================================================================================

name: Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tools
        run: |
          pip install ruff black mypy

      - name: Check changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.py

      - name: Lint changed Python files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Checking $file"
            ruff check "$file"
            black --check "$file"
          done

  file-headers:
    name: Verify File Headers
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check new files have headers
        run: |
          python scripts/add_file_headers.py --verify

  security-review:
    name: Security Review
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Security scan
        run: |
          pip install bandit safety
          bandit -r . -ll
          safety check

  size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4

      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const additions = pr.additions;
            const deletions = pr.deletions;
            const changes = additions + deletions;
            
            if (changes > 1000) {
              core.setFailed(`PR is too large (${changes} changes). Please split into smaller PRs.`);
            }

  cost-impact:
    name: Calculate Cost Impact
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate development time
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            let totalLines = 0;
            for (const file of files) {
              totalLines += file.additions;
            }
            
            // Elite team: 60 LOC/hour average
            const estimatedHours = totalLines / 60;
            const cost = estimatedHours * 150; // $150/hour
            
            const comment = `## ðŸ’° Cost Impact Analysis
            
            - **Lines Added:** ${totalLines}
            - **Estimated Time:** ${estimatedHours.toFixed(2)} hours
            - **Estimated Cost:** $${cost.toFixed(2)}
            
            *Based on elite team rate of $150/hour and 60 LOC/hour productivity*
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
